<?php
$GLOBALS['metabio_dataset_fields'] = array(
    'dataset_name', 
    'dataset_description', 
    'data_collector', 
    'data_holder_first_name',
    'data_holder_last_name',
    'data_holder_institution',
    'data_holder_email',
    'data_holder_phone',
    'data_holder_address',
    'other_institutions',
    'funding_sources',
    'dataset_format',
    'responsible_person',
    'additional_comments',
    'taxa_studied',
    'taxonomic_information', 
    'taxonomic_details',
    'study_design',
    'study_status',
    'sampling_approaches',
    'study_goals',
    'data_types',
    'frequency_of_sampling',
    'first_year',
    'last_year',
    'number_of_sites',
    'site_description',
    'site_habitat',
    'site_environment',
    'location_name',
    'geography',
    'publications_types',
    'publications',
    'publications_hyperlinks',
    'publications_dois',
    'collections',
    'files',
);

/**
 * Implements hook_node_info().
 */
function metabio_node_info() {
  return array(
    'metabio' => array(
      'name'        => t('Metabio Dataset'),
      'base'        => 'metabio',
      'module'      => 'metabio',
      'description' => t('Biodiversity metadata entry form for datasets.'),
      'has_body'    => FALSE
      ),
    );
}

// Implementation of hook_menu(): used to create a page for the form
function metabio_menu() {
  $items = array();

  $items['metabio/taxonomy_autocomplete'] = array(
    'page callback' => 'metabio_taxo_autocomplete_callback',
    'access arguments' => user_access('access content'),
    'type' => MENU_CALLBACK,
  );

  $items['node/%node/metabio_eml'] = array(
    'page callback' => 'metabio_eml_output_node',
    'page arguments' => array(1),
    'access callback' => 'node_access',
    'access arguments' => array('view', 1),
    'type' => MENU_CALLBACK,
    'file' => 'metabio.pages.inc',
  );

  return $items;
}

// Form builder. Form ID = function name
function metabio_form_alter(&$form, &$form_state, $form_id) {

  if($form_id == 'metabio_node_form') {

    $module_path = base_path().drupal_get_path('module', 'metabio');
    drupal_add_js(array('metabio_path' => $module_path), 'setting');

    $form['overview'] = array(
      '#title' => t('Overview'),
      '#type' => 'fieldset',
      '#collapsible' => TRUE,
      '#collapsed' => FALSE,
      '#group' => 'overviewtab',
      '#tree' =>FALSE,
      );

    $form['overview']['dataset_name'] = array(
      '#title' => t('Dataset name'),
      '#type' => 'textfield',
      '#size' => 50,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->dataset_name) ? $form['#node']->dataset_name : ""
      );

    $form['overview']['dataset_description'] = array(
      '#title' => t('Dataset description'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->dataset_description) ? $form['#node']->dataset_description : ""
      );

    $form['overview']['data_collector'] = array(
      '#title' => t('Data collector(s)'),
      '#type' => 'textfield',
      '#size' => 50,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->data_collector) ? $form['#node']->data_collector : ""
      );
    
    $form['overview']['data_holder_contact'] = array(
      '#title' => t('Contact information for data holder'),
      '#type' => 'fieldset', 
      '#collapsible' => FALSE, 
      );

    $form['overview']['data_holder_contact']['data_holder_first_name'] = array(
      '#title' => t('First name'),
      '#type' => 'textfield',
      '#size' => 50,
      '#required' => FALSE,
      '#title_display' => 'invisible',
      '#field_prefix' => t('First name'),
      '#default_value' => isset($form['#node']->data_holder_first_name) ? $form['#node']->data_holder_first_name : ""
      );

    $form['overview']['data_holder_contact']['data_holder_last_name'] = array(
      '#title' => t('Last name'),
      '#type' => 'textfield',
      '#size' => 50,
      '#required' => FALSE,
      '#title_display' => 'invisible',
      '#field_prefix' => t('Last name'),
      '#default_value' => isset($form['#node']->data_holder_last_name) ? $form['#node']->data_holder_last_name : ""
      );

    $form['overview']['data_holder_contact']['data_holder_institution'] = array(
      '#title' => t('Institution'),
      '#type' => 'textfield',
      '#size' => 50,
      '#required' => FALSE,
      '#title_display' => 'invisible',
      '#field_prefix' => t('Institution'),
      '#default_value' => isset($form['#node']->data_holder_institution) ? $form['#node']->data_holder_institution : ""
      );

    $form['overview']['data_holder_contact']['data_holder_email'] = array(
      '#title' => t('Email'),
      '#type' => 'textfield',
      '#size' => 50,
      '#required' => FALSE,
      '#title_display' => 'invisible',
      '#field_prefix' => t('Email'),
      '#default_value' => isset($form['#node']->data_holder_email) ? $form['#node']->data_holder_email : ""
      );

    $form['overview']['data_holder_contact']['data_holder_phone'] = array(
      '#title' => t('Telephone'),
      '#type' => 'textfield',
      '#size' => 50,
      '#required' => FALSE,
      '#title_display' => 'invisible',
      '#field_prefix' => t('Phone'),
      '#default_value' => isset($form['#node']->data_holder_phone) ? $form['#node']->data_holder_phone : ""
      );

    $form['overview']['data_holder_contact']['data_holder_address'] = array(
      '#title' => t('Address'),
      '#type' => 'textfield',
      '#size' => 50,
      '#required' => FALSE,
      '#title_display' => 'invisible',
      '#field_prefix' => t('Address'),
      '#default_value' => isset($form['#node']->data_holder_address) ? $form['#node']->data_holder_address : ""
      );

    $form['overview']['other_institutions'] = array(
      '#title' => t('Other institution(s) involved in data collection, analysis, archiving, etc. (e.g. university, government, department)'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->other_institutions) ? $form['#node']->other_institutions : ""
      );

    $form['overview']['funding_sources'] = array(
      '#title' => t('Funding sources for data collection'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->funding_sources) ? $form['#node']->funding_sources : ""
      );

    $form['overview']['dataset_format'] = array(
      '#title' => t('In what format is the dataset?'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->dataset_format) ? $form['#node']->dataset_format : ""
      );

    $form['overview']['responsible_person'] = array(
      '#title' => t('Person currently responsible for this metadata'),
      '#type' => 'textfield',
      '#size' => 50,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->responsible_person) ? $form['#node']->responsible_person : ""
      );

    $form['overview']['additional_comments'] = array(
      '#title' => t('Additional comments'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->additional_comments) ? $form['#node']->additional_comments : ""
      );

    $form['biology'] = array(
      '#title' => t('Biology'),
      '#type' => 'fieldset',
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#tree' => FALSE
      );

    $form['biology']['taxa_studied'] = array(
      '#title' => t('Taxa studied'),
      '#type' => 'textfield',
      '#size' => 100,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->taxa_studied) ? $form['#node']->taxa_studied : ""
      );
 
    $form['biology']['taxonomic_information'] = array(
      '#title' => t('Taxonomic information'),
      '#type' => 'checkboxes',
      '#options' => array(
        1 => t('Mammals'),
        2 => t('Marine mammals'),
        3 => t('Birds'),
        4 => t('Amphibians and reptiles'),
        5 => t('Fish'),
        6 => t('Insects'),
        7 => t('Arthropods'),
        8 => t('Crustaceans'),
        9 => t('Non-arthropod invertebrate animals'),
        10 => t('Vascular plants'),
        11 => t('Non-vascular plants'),
        12 => t('Mushrooms, molds and yeast'),
        13 => t('Unicellular organisms'),
        14 => t('Bacteria')
        ),
      '#default_value' => isset($form['#node']->taxonomic_information) && is_array($form['#node']->taxonomic_information) ? $form['#node']->taxonomic_information : array()
      );

    $form['biology']['taxonomic_details'] = array(
      '#type' => 'hidden',
      '#prefix' => '<h3>'.t('Taxonomic Details').'</h3>',
      '#default_value' => isset($form['#node']->taxonomic_details) ? $form['#node']->taxonomic_details : "",
      );


    $form['biology']['taxonomic_details_input'] = array(
      '#title' => t('Add taxa here by typing either the scientific or common name. Press the ENTER key when the name is selected'),
      '#type' => 'textfield',
      '#size' => 100,
      '#required' => FALSE,
      '#prefix' => "<table id='taxotbl'></table>",
      '#autocomplete_path' => db_table_exists('itis_names') ? 'metabio/taxonomy_autocomplete' : '',
      );  

    $form['study_details'] = array(
      '#title' => t('Study details'),
      '#type' => 'fieldset',
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#tree' =>FALSE,
      );

    $form['study_details']['study_design'] = array(
      '#title' => t('Describe the study design'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->study_design) ? $form['#node']->study_design : ""
      );

    $form['study_details']['study_status'] = array(
      '#title' => t('Study status'),
      '#type' => 'radios',
      '#options' => array(
        0 => t('Ongoing'), 
        1 => t('Complete')
        ),
      '#default_value' => isset($form['#node']->study_status) ? $form['#node']->study_status: ""
      );

    $form['study_details']['sampling_approaches'] = array(
      '#title' => t('Sampling approach(es)'),
      '#type' => 'checkboxes',
      '#options' => array(
        1 => t('Direct visual observation (e.g. Fieldwork)'),
        2 => t('Indirect visual observation (e.g. photos)'),
        3 => t('Active sampling (e.g. electrofishing, plant vouchers)'),
        4 => t('Passive sampling (e.g. insect or mammal traps)'),
        5 => t('Remote sensing')
        ),
      '#default_value' => isset($form['#node']->sampling_approaches) && is_array($form['#node']->sampling_approaches) ? $form['#node']->sampling_approaches : array()
      );

    $form['study_details']['study_goals'] = array(
      '#title' => t('Study goal(s)'),
      '#type' => 'checkboxes',
      '#options' => array(
        1 => t('Individual level (e.g. behaviour, physiology, autecology)'),
        2 => t('Community level (e.g. richness, distribution, composition)'),
        3 => t('Population/species level (e.g. systematic study)'),
        4 => t('Ecosystem level'),
        5 => t('Paleo-study'),
        6 => t('Complete inventory'),
        7 => t('Partial inventory'),
        8 => t('Single species')
        ),
      '#default_value' => isset($form['#node']->study_goals) && is_array($form['#node']->study_goals) ? $form['#node']->study_goals : array()
      );

    $form['study_details']['data_types'] = array(
      '#title' => t('Data type(s)'),
      '#type' => 'checkboxes',
      '#options' => array(
        1 => t('Species list'), 
        2 => t('Presence/absence'),
        3 => t('Abundance/relative abundance/frequency'),
        4 => t('Biomass'),
        5 => t('Size'),
        6 => t('Relative coverage'),
        7 => t('Genetics'),
        8 => t('Other')
        ),
      '#default_value' => isset($form['#node']->data_types) && is_array($form['#node']->data_types) ? $form['#node']->data_types : array()
      );

    $form['study_details']['frequency_of_sampling'] = array(
      '#title' => t('Frequency of sampling'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->frequency_of_sampling) ? $form['#node']->frequency_of_sampling : ""
      );

    $form['study_details']['first_year'] = array(
      '#title' => t('First year of data collection'),
      '#type' => 'date_select',
      '#date_format' => 'Y',
      '#default_value' => '2013',
      '#date_year_range' => '-100:0',
      '#required' => FALSE,
      '#date_label_position' => 'within',
      '#default_value' => isset($form['#node']->first_year) ? $form['#node']->first_year : ""
      );

    $form['study_details']['last_year'] = array(
      '#title' => t('Last year of data collection'),
      '#type' => 'date_select',
      '#date_format' => 'Y',
      '#default_value' => '2013',
      '#date_year_range' => '-100:0',
      '#required' => FALSE,
      '#date_label_position' => 'within',
      '#default_value' => isset($form['#node']->last_year) ? $form['#node']->last_year : ""
      );

    $form['site_details'] = array(
      '#title' => t('Site details'),
      '#type' => 'fieldset',
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#tree' =>FALSE
      );

    $form['site_details']['number_of_sites'] = array(
      '#title' => t('Number of sites included in the study'),
      '#type' => 'textfield',
      '#size' => 100,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->number_of_sites) ? $form['#node']->number_of_sites : ""
      );

    $form['site_details']['site_description'] = array(
      '#title' => t('Describe the site(s) (including distribution of sites if more than one)'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->site_description) ? $form['#node']->site_description : ""
      );

    $form['site_details']['site_habitat'] = array(
      '#title' => t('Describe site habitat(s)'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->site_habitat) ? $form['#node']->site_habitat : ""
      );

    $form['site_details']['site_environment'] = array(
      '#title' => t('Site environment(s)'),
      '#type' => 'checkboxes',
      '#options' => array(
        1 => t('Aquatic'), 
        2 => t('Terrestrial'),
        3 => t('Marine'),
        4 => t('Aerial')
        ),
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->site_environment) && is_array($form['#node']->site_environment) ? $form['#node']->site_environment : array()
      );

    $form['site_details']['location_name'] = array(
      '#title' => t('Location name'),
      '#type' => 'textfield',
      '#size' => 100,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->location_name) ? $form['#node']->location_name : ""
      );


    $form['site_details']['geography'] = array(
      '#title' => t('Geography'),
      '#type' => 'hidden',
      '#size' => 200,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->geography) ? $form['#node']->geography : "",
      '#prefix' => '<h3>'.t('Define extent/location of study site(s)').'</h3>'.t('Add the coordinates of each study site in the box below, one marker per line').'<br><textarea id="inputcoords" style="width:300px;height:200px;margin-left:0px;border: 3px solid #cccccc;"></textarea><br><button type="button" id="inputcoordsbut">'.t('Save and map').'</button><br><br>or add the sites on the map below.'.t('For points, single-click to delete. For polygons, double-click on a node to delete, click and drag to relocate.<br>'),
      '#suffix' => '<button type="button" id="polybut">'.t('Add polygon').'</button>
      <button type="button" id="pointbut">'.t('Add point(s)').'</button>
      <div id="map" width="700" height="500" style="width: 700px; height: 500px;overflow:visible;"></div>'
      );

    $form['citations'] = array(
      '#title' => t('Citations'),
      '#type' => 'fieldset',
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#tree' =>FALSE
      );

    $form['citations']['publications_types'] = array(
      '#title' => t('Publications'),
      '#type' => 'checkboxes',
      '#options' => array(
        1 => t('Publication(s) in peer reviewed literature'), 
        2 => t('Thesis/es'),
        3 => t('Report(s)'),
        4 => t('Unpublished'),
        5 => t('Database')
        ),
      '#default_value' => isset($form['#node']->publications_types) && is_array($form['#node']->publications_types) ? $form['#node']->publications_types : array()
      );

    $form['citations']['publications'] = array(
      '#title' => t('List of publications'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->publications) ? $form['#node']->publications : ""
      );

    $form['citations']['publications_hyperlinks'] = array(
      '#title' => t('Hyperlinks to publications'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->publications_hyperlinks) ? $form['#node']->publications_hyperlinks : ""
      );

    $form['citations']['publications_dois'] = array(
      '#title' => t('DOIs publications'),
      '#type' => 'textarea',
      '#cols' => 50,
      '#rows' => 6,
      '#required' => FALSE,
      '#default_value' => isset($form['#node']->publications_dois) ? $form['#node']->publications_dois : ""
      );

    $form['citations']['specimens'] = array(
      '#title' => t('Specimens'),
      '#type' => 'checkboxes',
      '#options' => array(
        1 => t('Specimens in a known collection'),
        2 => t('Specimens not in a known collection'),
        3 => t('No specimens collected')
        ),
      '#default_value' => isset($form['#node']->specimens) ? $form['#node']->specimens : array()
      );

    $form['citations']['collections'] = array(
      '#title' => t('Name of collection(s)'),
      '#type' => 'textarea',
      '#rows' => 6,
      '#cols' => 50,
      '#default_value' => isset($form['#node']->collections) ? $form['#node']->collections : array()
      );

    $form['filelist'] = array(
      '#title' => t('Files'),
      '#type' => 'fieldset',
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#tree' =>FALSE
      );

    $form['filelist']['files']= array(
      '#title' => t('Choose a file'),
      '#type' => 'file',
      '#title_display' => 'invisible',
      '#size' => 22,
      '#default_value' => isset($form['#node']->files) ? $form['#node']->files : ""
      );
    
    $js_files = array(
      'http://maps.google.com/maps/api/js?sensor=false',
      $module_path . '/javascript/metabio.map.js',
      $module_path . '/javascript/metabio.taxonomy.js',
    );
    
    $form['#attached']['js'] = $js_files;
    $form['#validate'][] = 'metabio_form_validate';
    $form['#submit'][] = 'metabio_form_submit';
  }
}


// Form validation handler.
function metabio_form_validate($form, &$form_state) {
  //do validation here if necessary
}


// Form submit handler.
function metabio_form_submit($form, &$form_state) {
  $form_state['values']['title'] = $form_state['values']['dataset_name'];
}


function metabio_insert($node) {
    if($node->type=='metabio'){
    db_insert('metabio_dataset')->fields(array_merge(array('nid' => $node->nid), _metabio_fields($node)))->execute();
  }
}

function metabio_update($node) {
  if($node->type=='metabio'){
    db_update('metabio_dataset')->fields(_metabio_fields($node))->condition('nid', $node->nid)->execute();
  }
}

function metabio_delete($node) {
  if($node->type=='metabio'){
    db_delete('metabio_dataset')->condition('nid', $node->nid)->execute();
  }
}

function metabio_load($nodes) {
 if($nodes[key($nodes)]->type=='metabio'){
    $result = db_select('metabio_dataset', 'm')->fields('m')->condition('m.nid', key($nodes))->execute();
    foreach($result as $record) {
      foreach($GLOBALS['metabio_dataset_fields'] as $field) {
        if ($field !== "geography" && is_array(json_decode($record->{$field},true))){ 
        $nodes[$record->nid]->{$field} = array_keys(json_decode($record->{$field},true));
        }else{
        $nodes[$record->nid]->{$field} = $record->{$field};
        }
      }
    }
  }
}

function _metabio_fields($node) {
  $fields = array();
  foreach($GLOBALS['metabio_dataset_fields'] as $field) {
    if(is_array($node->$field)){
      $tmp = array_filter($node->$field);
      $fields[$field] = (empty($tmp)) ? '' : json_encode($tmp);
    }else{
      $fields[$field] = $node->$field;
    }
  }
  return $fields;
}

function metabio_taxo_autocomplete_callback($string = "") {
  $matches = array();
  if ($string) {
    $result = db_select('ITIS_names')
      ->fields('ITIS_names',array('tsn','latin_name','english_name','french_name'))
      ->condition(db_or()
      ->condition('latin_name', db_like($string) . '%', 'LIKE')
      ->condition('english_name', db_like($string) . '%', 'LIKE')
      ->condition('french_name', db_like($string) . '%', 'LIKE'))
      ->range(0, 10)
      ->execute();
    foreach ($result as $row) {
      $eng = ($row->english_name === 'NULL') ? '' : ' - '.check_plain($row->english_name);
      $fr = ($row->french_name === 'NULL') ? '' : ' - '.check_plain($row->french_name);
      $matches[$row->latin_name] = check_plain($row->latin_name).$eng.$fr;
    }
  }
  drupal_json_output($matches);
}

?>